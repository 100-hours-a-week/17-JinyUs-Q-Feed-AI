name: AI CI
# 테스트
on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches:
      - main
permissions:
  contents: read
  pull-requests: write

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      # 코드 체크아웃
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gitleaks 전체 히스토리 검사 위해 설정

      # Gitleaks - credential/secret 노출 검사
      # - name: Gitleaks
      #   uses: gitleaks/gitleaks-action@v2
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Ruff 린트 검사
      - name: Lint code with Ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: "check ."

      # Python 3.12 설정
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # uv 설치
      - name: Install uv
        uses: astral-sh/setup-uv@v7

      # 의존성 설치
      - name: Install dependencies
        run: uv sync

      # .env 파일 생성
      - name: Create .env file
        run: |
          cat > .env << EOF
          HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

      # # 테스트 실행
      # - name: Run test
      #   run: uv run pytest

      # pyproject.toml 버전 추출
      - name: Extract version
        id: version
        run: |
          VERSION=$(python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print(data['project']['version'])
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 배포 아티팩트 생성
      - name: Package artifact
        run: |
          mkdir deploy-package
          rsync -av \
            --exclude='.git*' \
            --exclude='tests/' \
            --exclude='*.pyc' \
            --exclude='__pycache__/' \
            --exclude='.github/' \
            --exclude='.env*' \
            --exclude='.ruff_cache/' \
            --exclude='deploy-package/' \
            ./ deploy-package/
          tar -czf ai-${{ steps.version.outputs.version }}.tar.gz -C deploy-package .

      # 아티팩트 업로드
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-v${{ steps.version.outputs.version }}
          path: ai-${{ steps.version.outputs.version }}.tar.gz

      # CI 통과 시 Discord 알림
      - name: Discord 알림 (CI 통과)
        if: success()
        continue-on-error: true
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "✅ AI CI 통과",
              "description": "빌드·린트 검사·의존성 설치·아티팩트 업로드까지 완료되었습니다.",
              "color": 3066993,
              "fields": [
                {"name": "브랜치", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "커밋", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "트리거", "value": "${{ github.event_name }}", "inline": true}
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: lint-test

    # main 브랜치로 push된 경우에만 배포 실행 (PR에서는 실행하지 않음)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: 패키지 버전 추출
        id: package-version
        run: |
          VERSION=$(python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print(data['project']['version'])
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: 빌드 산출물 다운로드
        uses: actions/download-artifact@v4
        with:
          name: ai-v${{ steps.package-version.outputs.version }}

      # 서버로 산출물을 전송한 뒤, 서버 내부 deploy-ai.sh로 교체/백업 처리
      - name: SSH 키 설정
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.QFEED_EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.QFEED_EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: 서버 연결 테스트
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            ${{ secrets.QFEED_EC2_USER }}@${{ secrets.QFEED_EC2_HOST }} \
            "echo 'Connection successful'"

      - name: 서버로 파일 업로드 (SCP)
        timeout-minutes: 5
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=60 \
            -o ServerAliveInterval=10 \
            -o ServerAliveCountMax=3 \
            ai-${{ steps.package-version.outputs.version }}.tar.gz \
            ${{ secrets.QFEED_EC2_USER }}@${{ secrets.QFEED_EC2_HOST }}:/tmp/

      - name: 서버에서 배포 실행 (deploy-ai.sh)
        timeout-minutes: 5
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QFEED_EC2_HOST }}
          username: ${{ secrets.QFEED_EC2_USER }}
          key: ${{ secrets.QFEED_EC2_SSH_KEY }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            sudo /srv/qfeed/deploy-ai.sh /tmp/ai-${{ steps.package-version.outputs.version }}.tar.gz

  # CI 실패 시 어떤 과정에서 실패했는지 Discord 알림
  discord-notify-failure:
    name: Discord 알림 (CI 실패)
    runs-on: ubuntu-latest
    needs: [lint-test, deploy]
    if: always() && (needs.lint-test.result == 'failure' || needs.deploy.result == 'failure')
    steps:
      - name: 실패한 Job/Step 조회
        id: failed
        run: |
          FAILED_JOB=""
          FAILED_STEP=""
          if [ "${{ needs.lint-test.result }}" == "failure" ]; then
            FAILED_JOB="lint-test"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            FAILED_JOB="deploy"
          fi
          if [ -z "$FAILED_JOB" ]; then
            FAILED_JOB="(알 수 없음)"
            FAILED_STEP="(알 수 없음)"
          else
            FAILED_STEP="(확인 필요)"
          fi
          echo "job=$FAILED_JOB" >> $GITHUB_OUTPUT
          echo "step=$FAILED_STEP" >> $GITHUB_OUTPUT

      - name: Discord 알림 (CI 실패)
        continue-on-error: true
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "❌ AI CI 실패",
              "description": "**실패한 Job:** ${{ steps.failed.outputs.job }}\n**실패한 Step:** ${{ steps.failed.outputs.step }}",
              "color": 15158332,
              "fields": [
                {"name": "브랜치", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "커밋", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "워크플로우", "value": "[Run 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
